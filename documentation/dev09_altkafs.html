<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <title>Awami Nastaliq Developer Documentation</title>
    <meta name="author" content="SIL Writing Systems Technology">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <link rel="stylesheet" href="./assets/css/theme.css">
    <link rel="stylesheet" href="./assets/css/webfonts.css">
</head>
<body>
<div class="container">
<article class="article">
    <header>
        <h1 class="title">Awami Nastaliq Developer Documentation</h1>
    </header>
    <h1 id="alternate-height-kafs-and-gafs">Alternate Height Kafs and Gafs</h1>
    <p>One of the challenges of Nastaliq script is that long contextual sequences can get quite high and either be clipped or collide with the line above. Kaf and gafs are a particular problem because of their tall shape.</p>
    <p>A different problem is that the upper diagonal stroke of the kaf may not allow enough room above preceding glyphs for a stack of large nuqtas and diacritics.</p>
    <p>In some styles of Nastaliq, a “bent” or flattened kaf shape is used to avoid the first problem in particular. For Awami Nastaliq, we have instead chosen to support a variety of kaf heights, which helps solve both problems.</p>
    <p>The approach is to create a set of bases that correspond to each kaf shape, along with a set of kaf and gaf tops consisting of just the stem and upper diagonal stroke. The tops are attached to the bases using an attachment point called <code>kafTop</code>.</p>
    <p>Because these forms are admittedly not quite as perfectly shaped as a single kaf form, this approach is only used when we need an alternate-height glyph, not for the default, standard-height shapes.</p>
    <p>For comparison, here we can see five versions of the kaf; the middle form is the default shape and height. (Notice that for the shortest form, the short form of the seen has been used as well; see the following section.)</p>
    <img src="assets/images/dev_doc/FiveHtKafs.png" title="fig:" alt="Five heights of the kaf" />
    <figcaption>
    Five heights of the kaf
    </figcaption>
    <p>Several defined constants in the code (<code>SHORTKAF_HT</code> and <code>SHORTERKAF_HT</code>) are used to recognize situations where an adjustment is needed. These were calculated empirically based on the vertical size of the kaf glyphs and the defined ascent of the font.</p>
    <p>There are five alternate-height kafs:</p>
    <p><strong>Tall:</strong> these are used when preceding glyphs have a stack of nuqtas and diacritics that would collide with the upper stroke of the kaf, and/or to avoid a collision with a previous kaf or gaf.</p>
    <p>These alternates are not dependent on a feature being set. They only exist for medials.</p>
    <img src="assets/images/dev_doc/TallKafs.png" title="fig:" alt="Tall kafs and gafs" />
    <figcaption>
    Tall kafs and gafs
    </figcaption>
    <p><strong>Taller:</strong> these are used to avoid collisions or extreme kerning with very tall previous items such as alef-madda or alef with a diacritic. They only exist for initials, and are not dependent on a feature.</p>
    <img src="assets/images/dev_doc/TallerKafs.png" title="fig:" alt="Taller kafs and gafs" />
    <figcaption>
    Taller kafs and gafs
    </figcaption>
    <p><strong>Medium/short:</strong> (_medshort): these kafs have a standard-height stem, but the diagonal stroke has been shortened to avoid colliding with a previous tall glyph (lam, tah, kaf, or gaf) or large nuqat. These only exist for medial forms, and they are not dependent on a feature being set.</p>
    <img src="assets/images/dev_doc/MedShortKafs.png" title="fig:" alt="Medium-short kafs" />
    <figcaption>
    Kafs and gafs with shorter diagonal strokes
    </figcaption>
    <p><strong>Short:</strong> these are used when the contextual sequence gets high enough to risk clipping or collisions. They are only used when the “Short Forms” feature is set to “Kaf and gafs” or “All.” For obvious reasons, they are most often used for kafs near the beginning of the sequence, but they can be needed for both initials and medials.</p>
    <img src="assets/images/dev_doc/ShortKaf.png" title="fig:" alt="Short kaf" />
    <figcaption>
    Short kaf
    </figcaption>
    <p><strong>Shorter:</strong> these forms are used when the short forms don’t provide quite enough adjustment due to an extremely high sequence.</p>
    <img src="assets/images/dev_doc/ShorterKaf.png" title="fig:" alt="Shorter kaf" />
    <figcaption>
    Shorter kaf
    </figcaption>
    <p>The short and shorter forms are also used for gafs in combination with the tall or medium/short forms to avoid collisions.</p>
    <img src="assets/images/dev_doc/ShortGafPlusKaf.png" title="fig:" alt="Short gafs before kaf" />
    <figcaption>
    Short/shorter gafs used to avoid collisions with following kafs and gafs
    </figcaption>
    <p>What happens when you need a tall kaf to avoid a collision, but this causes the text to be too high which would normally be solved using a short kaf? The answer is that fixing collisions is the priority, so a tall kaf is used.</p>
    <img src="assets/images/dev_doc/TallKafTallSeq.png" title="fig:" alt="Tall sequence with tall kaf" />
    <figcaption>
    The sequence on the right uses a "shorter" kaf due to the height, but the center and left-most sequences use the standard and tall kaf (respectively) due to the presence of the sheen and diacritic.
    </figcaption>
    <h2 id="special-cases-of-alternate-kafs">Special cases of alternate kafs</h2>
    <p>Some of the kaf forms do not lend themselves to this approach - they are shaped differently enough from the other forms, or are naturally enough shorter, that there is no good way to break them into base + top in a way that is consistent with the other kaf forms. For these, the kaf base is simply a complete form and it is followed by a glyph called <code>g__kafTop_m_bogus</code> in lieu of the top. (The reason for including this bogus glyph is that these special forms are created during the positioning pass, and glyph deletion is not possible at that point.) These unbroken forms are:</p>
    <ul>
    <li>gKafIniMm_short, gGafIniMm_short</li>
    <li>gKafMedJm_short, gGafMedJm_short</li>
    <li>gKafMedJm_tall, gGafMedJm_tall</li>
    <li>gKafMedJm_lowentry, gGafMedJm_lowentry - these have a lower entry AP for the previous glyph to be attached to, rather than a taller stem, which has the same effect of allowing extra space below the diagonal stroke</li>
    </ul>
    <p>Compare the "lowered" and normal forms below. Notice how the entry of the lowered form effectively creates a taller kaf.</p>
    <img src="assets/images/dev_doc/KafMedJmLowVsNormal.png" title="fig:" alt="Lowered and normal pre-jeem kaf" />
    <figcaption>
    Lowered and normal forms of the pre-jeem medial kaf.
    </figcaption>
    <p>Note that these are not repositioned or reattached, so their exit APs must be in the same position as the standard forms they are replacing.</p>
    <p>There are a couple cases where we never make a change to the default form:</p>
    <ul>
    <li>gKafIniBy, gGafIniBy - these forms are always the penultimate of the sequence (since bariyehs are finals), so shortening them is never necessary, and making them taller is never necessary since they are initials and will never have anything preceding.</li>
    </ul>
    <h2 id="a-note-about-kaf-glyph-outline-vertical-positioning">A note about kaf glyph outline vertical positioning</h2>
    <p>You’ll notice that for most characters, the initials and medials appear to be at random or arbitrary vertical positions in the UFO files. This happened for historical reasons, and it’s generally not a problem because ultimately the vertical positioning is controlled by the attachment mechanism. In other words, initials and medials are always attached to a following (medial or final) glyph which effectively anchors their vertical position; until then they are essentially floating in space.</p>
    <p>However, this was less than ideal when we started working with alternate height kafs. We use the <code>position</code> attribute to evaluate the vertical height of kafs that may need to be adjusted, and assume a standard height of the kaf stem and diagonal stroke. But if the outline of the kaf is not at a predictable position relative to that <code>position.y</code> attribute, we’d get unpredictable results. We could get around this by including the bounding box in the calculation, but it simplifies things to ensure that all the kaf glyphs are a consistent height from the baseline. Specifically, all the <code>_exit_lamKaf</code> anchors are at exactly 686 in Regular and 720 in Bold, and the highest nodes are at 2214 in Regular and 2327 in Bold. (Exceptions are some kehehMed.jm forms that are handled specially.) This way we can build in an assumption of the absolute height of the kaf based on the <code>position.y</code> attribute.</p>
    <p>Another case where the position of the glyphs in the UFO matters is where the kaf-base (to which the alternate height kaf-top is attached) connects to the following glyph. We don’t reattach the kaf-base, so it needs to be in the exact position that the original kaf was. This is especially noticeable for the .snsn forms, whose interface is unforgiving.</p>
    <!-- PRODUCT SITE ONLY
    [font id='awami' face='AwamiNastaliq-Regular' size='150%' rtl=1]
    [font id='awamiL' face='AwamiNastaliq-Regular' size='150%' ltr=1]
    -->
    <footer class="footer">
        <p>This guide is from the <a href="https://software.sil.org/awami/" title="" class="active">Awami Nastaliq project</a> version 3.100 and is copyright © 2014-2023 SIL International.</p>
    </footer>
</article>
</div>
</body>
</html>