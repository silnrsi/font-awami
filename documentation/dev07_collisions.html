<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <title>Awami Nastaliq Developer Documentation</title>
    <meta name="author" content="SIL Writing Systems Technology">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <link rel="stylesheet" href="./assets/css/theme.css">
    <link rel="stylesheet" href="./assets/css/webfonts.css">
</head>
<body>
<div class="container">
<article class="article">
    <header>
        <h1 class="title">Awami Nastaliq Developer Documentation</h1>
    </header>
    <h1 id="collision-fixing">Collision Fixing</h1>
    <p>To understand Awami's collision fixing process, you’ll need to have an understanding of Graphite’s collision avoidance mechanisms. Documentation of this is available in the GDL manual and is not duplicated here. This section gives a high-level overview of the process.</p>
    <p>A general principle is that the bases are held in place and moveable elements - nuqtas, diacritics, hamzas, and other modifying marks are shifted to avoid collisions. Elements that are directly attached to the bases, such as bars and rings, do not get moved. The same is true of the gaf strokes which are sometimes rendered as separate glyphs. Some elements such as the small V above a lam cannot be moved much because shifting the V off center would not produce a pleasing result.</p>
    <p>We perform collision avoidance in three rounds. GDL allows us to set the relevant attributes and perform the fixes in the same pass, but we divide the process into two (or more) passes for the sake of debugging.</p>
    <p>Remember that collision avoidance only occurs in the positioning table.</p>
    <p><strong>Round 1 (passes 3 &amp; 4):</strong> The first round fixes collisions for nuqtas and similar inherent glyphs (hamza, heh hook, small V, etc.). The bulk of the pass involves special cases where the default collision parameters aren’t adequate to give a good result. The default rules are found near the bottom of pass 3.</p>
    <p><strong>Round 2 (passes 11 &amp; 12):</strong> The second round mainly deals with collisions involving diacritics. Most of pass 11 involves setting the collision attributes for diacritics. The default rules are at the bottom of the pass.</p>
    <p>We also set collision attributes in pass 10 to handle some special cases.</p>
    <p>Unlike pass 4, the collision-fixing in pass 12 also performs kerning (see <a href="dev08_kerning.html">the section on Kerning</a>). This is used to both fix collisions and improve the spacing.</p>
    <p>There are also some cases where we essentially redo nuqta-type fixes:</p>
    <ul>
    <li>If a glyph is near an alternate-height kaf or gaf, the substituted kaf might have introduced a new collision.</li>
    <li>Nuqtas attached to newly substituted short finals may fit differently now and need adjustment.</li>
    <li>Hamzas that are treated like diacritics need to be handled, since they may be attached differently than previously.</li>
    </ul>
    <p><strong>Round 3 (passes 13 &amp;14):</strong> The final collision-fixing pass handles a couple clean-up operations:</p>
    <ul>
    <li>Adjustments to the right-hand margin</li>
    <li>Adjustments to the kerning of low punctuation (full-stop and comma)</li>
    </ul>
    <p>Since it handles such a few cases, pass 14 sets some rules and runs the collision algorithm both in the same pass.</p>
    <h2 id="the-kaf-exclusion-mechanism">The kaf exclusion mechanism</h2>
    <p>A particular challenge has to do with the space above a kaf or gaf. Moveable glyphs often get squeezed underneath a kaf, and the collision avoidance algorithm would naturally move them above the diagonal stroke, resulting in a misleading layout.</p>
    <p>To solve this problem, we essentially extend the space “owned” by the kaf using the exclusion mechanism. This uses a special glyph, <code>g__kaf_exclude</code>, that is not actually rendered but is added in to the “ink” of the kaf when performing collision avoidance. This is set using a statement such as:</p>
    <p><code>g_kafMed {collexclude.glyph = g__kaf_exclude};</code></p>
    <p>Including this extra ink in the kaf, computationally speaking, generally has the effect of moving preceding glyphs down and right rather than up above the kaf.</p>
    <p>On the other hand, characters such as kaf with three dots above and ngoeh (gaf with two dots above) do in fact want their associated nuqtas to be placed in directly above the base, and so we must omit the exclusion glyph in these situations (otherwise those nuqtas would get moved to an extreme position far above the exclusion glyph).</p>
    <img src="assets/images/dev_doc/KafExclusion.png" title="fig:" alt="Kaf exclusion area" />
    <figcaption>
    <em>Right:</em> The exclusion area, shown in Graide (but not in the final rendering), prevents the nuqtas on the hah form from jumping above the kaf's diagonal stroke in order to fix the collsion. <em>Left:</em> the ngoeh needs the nuqta to be positioned above the diagonal stroke, so the exclusion area is omitted.
    </figcaption>
    <!-- PRODUCT SITE ONLY
    [font id='awami' face='AwamiNastaliq-Regular' size='150%' rtl=1]
    [font id='awamiL' face='AwamiNastaliq-Regular' size='150%' ltr=1]
    -->
    <footer class="footer">
        <p>This guide is from the <a href="https://software.sil.org/awami/" title="" class="active">Awami Nastaliq project</a> version 3.100 and is copyright © 2014-2023 SIL International.</p>
    </footer>
</article>
</div>
</body>
</html>